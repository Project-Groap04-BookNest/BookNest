{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto mt-10 bg-white rounded-xl p-6 shadow">
  <h2 class="text-xl font-semibold mb-4">Manage Users</h2>

  <table class="w-full text-left border-collapse">
    <thead>
      <tr class="border-b">
        <th class="py-2">ID</th>
        <th class="py-2">Name</th>
        <th class="py-2">Email</th>
        <th class="py-2">Role</th>
        <th class="py-2">Action</th>
      </tr>
    </thead>
    <tbody id="users-body"></tbody>
  </table>

  <div id="err" class="mt-3 text-red-600 text-sm"></div>
</div>

<script>
async function loadUsers() {
  const tbody = document.getElementById('users-body');
  const err = document.getElementById('err');
  tbody.innerHTML = '';
  err.textContent = '';

  try {
    const res = await fetch('/api/get_users');
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      err.textContent = data.error || ('HTTP ' + res.status);
      return;
    }
    const users = await res.json();
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.className = 'border-b';
      tr.innerHTML = `
        <td class="py-2">${u.id}</td>
        <td class="py-2">${u.name}</td>
        <td class="py-2">${u.email}</td>
        <td class="py-2">
          <select id="role-${u.id}" class="border rounded px-2 py-1">
            <option value="user" ${u.role === "user" ? "selected" : ""}>User</option>
            <option value="stock_keeper" ${u.role === "stock_keeper" ? "selected" : ""}>Stock Keeper</option>
            <option value="admin" ${u.role === "admin" ? "selected" : ""}>Admin</option>
          </select>
        </td>
        <td class="py-2">
          <button onclick="updateRole(${u.id})"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
            Update
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    err.textContent = 'Cannot load users: ' + e.message;
  }
}

async function updateRole(userId) {
  const newRole = document.getElementById('role-' + userId).value;
  const err = document.getElementById('err');
  err.textContent = '';

  try {
    const res = await fetch(`/api/users/${userId}/role`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role: newRole })
    });

    const data = await res.json();
    if (!res.ok) {
      err.textContent = data.error || ('HTTP ' + res.status);
      return;
    }

    // reload users table
    await loadUsers();
  } catch (e) {
    err.textContent = 'Update failed: ' + e.message;
  }
}

loadUsers();
</script>
{% endblock %}
